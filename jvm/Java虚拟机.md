# 一、JVM的组成

![img](/Users/jack/Desktop/md/images/01.jpg)

- **类加载器**，在 JVM 启动时或者类运行时将需要的 class 加载到 JVM 中。
- **内存区**，将内存划分成若干个区以模拟实际机器上的存储、记录和调度功能模块，如实际机器上的各种功能的寄存器或者 PC 指针的记录器等。

- **执行引擎**，执行引擎的任务是负责执行 class 文件中包含的字节码指令，相当于实际机器上的 CPU 。
- **本地方法调用**，调用 C 或 C++ 实现的本地方法的代码返回结果。

# 二、Java 内存堆和栈区别

- **栈内存用来存储基本类型的变量和对象的引用变量；堆内存用来存储Java中的对象，无论是成员变量，局部变量，还是类变量，它们指向的对象都存储在堆内存中。**
- 栈内存归属于单个线程，==每个线程都会有一个栈内存==，其存储的变量只能在其所属线程中可见，即栈内存可以理解成线程的私有内存；==堆内存中的对象对所有线程可见==。堆内存中的对象可以被所有线程访问。
- **如果栈内存没有可用的空间存储方法调用和局部变量，JVM 会抛出 `java.lang.StackOverFlowError` 错误；如果是堆内存没有可用的空间存储生成的对象，JVM 会抛出 `java.lang.OutOfMemoryError` 错误。**
- 栈的内存要远远小于堆内存，如果你使用递归的话，那么你的栈很快就会充满。`-Xss` 选项设置栈内存的大小，`-Xms` 选项可以设置堆的开始时的大小。

即：

> JVM 中堆和栈属于不同的内存区域，使用目的也不同。栈常用于保存方法帧和局部变量，而对象总是在堆上分配。栈通常都比堆小，也不会在多个线程之间共享，而堆被整个 JVM 的所有线程共享。

![img](/Users/jack/Desktop/md/images/03.png)

# 三、JAVA 对象创建的过程

JAVA 对象创建的过程，如下图所示：![JAVA 对象创建的过程](/Users/jack/Desktop/md/images/06-20190404222153737.png)

- **Java 中对象的创建就是在堆上分配内存空间的过程，此处说的对象创建仅限于 new 关键字创建的普通 Java 对象，不包括数组对象的创建。**

## 1）检测类是否被加载

​	当虚拟机遇到 `new` 指令时，==首先先去检查这个指令的参数是否能在常量池中**定位到一个类的符号引用**，并且检查这个符号引用代表的类是否已被加载、解析和初始化过。==如果没有，就执行类加载过程。

## 2）为对象分配内存

​	类加载完成以后，虚拟机就开始为对象分配内存，此时所需内存的大小就已经确定了。只需要在堆上分配所需要的内存即可。

**具体的分配内存有两种情况：第一种情况是内存空间绝对规整，第二种情况是内存空间是不连续的。**

- 对于内存绝对规整的情况相对简单一些，虚拟机只需要在被占用的内存和可用空间之间移动指针即可，这种方式被称为“**指针碰撞**”。
- 对于内存不规整的情况稍微复杂一点，这时候虚拟机需要维护一个列表，来记录哪些内存是可用的。分配内存的时候需要找到一个可用的内存空间，然后在列表上记录下已被分配，这种方式成为“**空闲列表**”。

**多线程并发时会出现正在给对象 A 分配内存，还没来得及修改指针，对象 B 又用这个指针分配内存，这样就出现问题了。解决这种问题有两种方案：**

- 第一种，是采用同步的办法，使用 CAS 来保证操作的原子性。
- 另一种，**是每个线程分配内存都在自己的空间内进行，即是每个线程都在堆中预先分配一小块内存，称为本地线程分配缓冲（Thread Local Allocation Buffer, TLAB），分配内存的时候再TLAB上分配，互不干扰。可以通过 `-XX:+/-UseTLAB` 参数决定。**

## 3）为分配的内存空间初始化零值

​	对象的内存分配完成后，还需要将对象的内存空间都初始化为零值，这样能保证对象即使没有赋初值，也可以直接使用。

## 4）对对象进行其他设置

​	**分配完内存空间，初始化零值之后，虚拟机还需要对对象进行其他必要的设置，设置的地方都在对象头中，包括这个对象所属的类，类的元数据信息，对象的 hashcode ，GC 分代年龄等信息。**

## 5）执行 init 方法

​	执行完上面的步骤之后，在虚拟机里这个对象就算创建成功了，但是对于 Java 程序来说还需要执行 init 方法才算真正的创建完成，因为这个时候对象只是被初始化零值了，还没有真正的去根据程序中的代码分配初始值，**调用了 init 方法之后，这个对象才真正能使用。**

到此为止一个对象就产生了，这就是 new 关键字创建对象的过程。过程如下：

![JAVA 对象创建的过程](/Users/jack/Desktop/md/images/07-20190404222153727.png)

> 另外，这个问题，面试官可能引申成 “`A a = new A()` 经历过什么过程”的问题。

























































